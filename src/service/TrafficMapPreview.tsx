import { useContext, createContext, useState, useEffect, useRef } from "react";
import { Box } from "@mui/material";
import Graphic from "@arcgis/core/Graphic";
import Point from "@arcgis/core/geometry/Point";
import SimpleMarkerSymbol from "@arcgis/core/symbols/SimpleMarkerSymbol";
import Map from "@arcgis/core/Map";
import MapView from "@arcgis/core/views/MapView";
import GraphicsLayer from "@arcgis/core/layers/GraphicsLayer";
import Basemap from "@arcgis/core/Basemap";
import WebTileLayer from "@arcgis/core/layers/WebTileLayer";
import FeatureLayer from "@arcgis/core/layers/FeatureLayer";
import { useTrafficMapContext } from "@/hooks/useGetContext";
import { parseWKTPolygon } from "./arcGIS/parser";
import Polygon from "@arcgis/core/geometry/Polygon";

import MyDrawer from "@/components/MyDrawer";
// Ëß£Êûê WKT
const points = parseWKTPolygon(
  "POLYGON((121.29448166146477 24.919028160170058,121.29447693632446 24.919024108525516,121.29447118359082 24.919028420114472,121.29447512662043 24.919034145364016,121.29448166146477 24.919028160170058))"
); // [[lng, lat], ...]

// ArcGIS Polygon ÈúÄË¶Å [ [lng, lat], ... ]
const polygon = new Polygon({
  rings: [points as number[][]],
  spatialReference: { wkid: 4326 },
});

const polygonGraphic = new Graphic({
  geometry: polygon,
  symbol: {
    type: "simple-fill",
    color: [255, 0, 0, 0.3],
    outline: { color: [255, 0, 0], width: 2 },
  },
});

export default function TrafficMapPreview() {
  return (
    <TrafficDataProvider>
      <Box
        sx={{
          height: "100%",
          position: "relative",
        }}
      >
        <TrafficMap />
        <CustomButton />
      </Box>
    </TrafficDataProvider>
  );
}

// contexts/TrafficDataContext.jsx
function getPolygonCentroid(points: number[][]) {
  let lngSum = 0,
    latSum = 0;
  points.forEach(([lng, lat]) => {
    lngSum += lng;
    latSum += lat;
  });
  return [lngSum / points.length, latSum / points.length];
}
const TrafficDataContext = createContext<any>({});

export const useTrafficData = () => {
  const context = useContext(TrafficDataContext);
  if (!context) {
    throw new Error("useTrafficData must be used within TrafficDataProvider");
  }
  return context;
};

const iconSize = 36;

const CustomButton = () => {
  const { view } = useTrafficMapContext();

  const handleLocationClick = () => {
    if (navigator.geolocation) {
      navigator.geolocation.getCurrentPosition(
        (position) => {
          console.log("Áî®Êà∂‰ΩçÁΩÆ:", position.coords);
          view.current?.goTo({
            center: [position.coords.longitude, position.coords.latitude],
            zoom: 15,
          });
          // ÈÄôË£°ÂèØ‰ª•Ë™øÁî®Âú∞Âúñ API ÁßªÂãïÂà∞Áî®Êà∂‰ΩçÁΩÆ
        },
        (error) => {
          console.error("ÂèñÂæó‰ΩçÁΩÆÂ§±Êïó:", error);
        }
      );
    }
  };
  return (
    <Box
      sx={{
        position: "absolute",
        top: 0,
        right: 0,
        zIndex: 1000,
      }}
    >
      <MyDrawer />
    </Box>
  );
};

export const TrafficDataProvider = ({
  children,
}: {
  children: React.ReactNode;
}) => {
  const [trafficEvents, setTrafficEvents] = useState([]);
  const [parkingLots, setParkingLots] = useState([]);
  const [loading, setLoading] = useState(false);
  const [error, setError] = useState(null);
  const [lastUpdate, setLastUpdate] = useState(new Date());
  const [selectedLayers, setSelectedLayers] = useState({
    traffic: true,
    parking: true,
    cameras: true,
    construction: true,
  });
  const [notifications, setNotifications] = useState([]);

  const loadTrafficData = async () => {
    setLoading(true);
    setError(null);

    try {
      const [events, parking] = await Promise.all([
        tdxService.getTrafficEvents("Taichung"),
        tdxService.getParkingData("Taichung"),
      ]);

      setTrafficEvents(events);
      setParkingLots(parking);
      setLastUpdate(new Date());

      // Ê∑ªÂä†ÊàêÂäüÈÄöÁü•
    } catch (error) {
      console.error("ËºâÂÖ•‰∫§ÈÄöË≥áÊñôÂ§±Êïó:", error);
      setError(error.message);
    } finally {
      setLoading(false);
    }
  };

  const toggleLayer = (layerName) => {
    setSelectedLayers((prev) => ({
      ...prev,
      [layerName]: !prev[layerName],
    }));
  };

  const removeNotification = (id) => {
    setNotifications((prev) =>
      prev.filter((notification) => notification.id !== id)
    );
  };

  useEffect(() => {
    loadTrafficData();
    const interval = setInterval(loadTrafficData, 30000);
    return () => clearInterval(interval);
  }, []);

  const value = {
    trafficEvents,
    parkingLots,
    loading,
    error,
    lastUpdate,
    selectedLayers,
    notifications,
    loadTrafficData,
    toggleLayer,
    removeNotification,
  };

  return (
    <TrafficDataContext.Provider value={value}>
      {children}
    </TrafficDataContext.Provider>
  );
};

const TrafficMap = () => {
  const mapDiv = useRef<HTMLDivElement>(null);
  const { view } = useTrafficMapContext();
  const { trafficEvents, parkingLots, selectedLayers } = useTrafficData();
  useEffect(() => {
    initializeMap();
  }, []);

  useEffect(() => {
    if (view.current) {
      updateMapLayers();
    }
  }, [trafficEvents, parkingLots, selectedLayers]);

  const initializeMap = async () => {
    try {
      // ÂúãÂúüÊ∏¨Áπ™‰∏≠ÂøÉ WMTS ÊúçÂãô
      const basemapLayers = {
        // ÈÄöÁî®ÁâàÈõªÂ≠êÂú∞Âúñ
        emap: "https://wmts.nlsc.gov.tw/wmts/EMAP/default/GoogleMapsCompatible/{z}/{y}/{x}",

        // Âú∞ÂΩ¢Âúñ
        terrain:
          "https://wmts.nlsc.gov.tw/wmts/DTM/default/GoogleMapsCompatible/{z}/{y}/{x}",
      };

      const taiwanBaseMapLayer = new WebTileLayer({
        urlTemplate: basemapLayers.emap,
        copyright: "¬© ÂÖßÊîøÈÉ®ÂúãÂúüÊ∏¨Áπ™‰∏≠ÂøÉ",
      });

      const taiwanBaseMap = new Basemap({
        baseLayers: [taiwanBaseMapLayer],
        title: "Âè∞ÁÅ£ÈõªÂ≠êÂú∞Âúñ",
        id: "taiwan-emap",
      });

      // Âä†ÂÖ•ÊîØÊè¥ËÅöÂêàÁöÑ FeatureLayer
      const featureLayer = new FeatureLayer({
        url: "‰Ω†ÁöÑÂúñÂ±§ÊúçÂãôÁ∂≤ÂùÄ", // ‰æãÂ¶Ç: https://services.arcgis.com/xxx/arcgis/rest/services/your_layer/FeatureServer/0
        featureReduction: {
          type: "cluster",
          clusterRadius: "100px", // ËÅöÂêàÂçäÂæë
          popupTemplate: {
            title: "Áæ§ÈõÜÂÖßÊúâ {cluster_count} Á≠ÜË≥áÊñô",
            content: "ÈªûÊìäÂ±ïÈñãÊü•ÁúãË©≥Á¥∞Ë≥áÊñô",
          },
        },
      });

      const map = new Map({
        basemap: taiwanBaseMap,
      });

      map.add(featureLayer);

      view.current = new MapView({
        container: mapDiv.current,
        map,
        center: [120.6478, 24.1477], // Âè∞‰∏≠Â∏Ç‰∏≠ÂøÉ
        zoom: 13,
        ui: {
          components: ["zoom"], // ÁßªÈô§È†êË®≠ÁöÑ compassÔºåÊàëÂÄëÁî® MUI ÊéßÂà∂
        },
      });

      // Âª∫Á´ãÂúñÂ±§
      view.current.map.addMany([
        new GraphicsLayer({ id: "traffic-events" }),
        new GraphicsLayer({ id: "parking-lots" }),
        new GraphicsLayer({ id: "cameras" }),
        new GraphicsLayer({ id: "construction" }),
      ]);

      await view.current.when();
      // Ê∏¨Ë©¶ÔºöÂä†‰∏ÄÂÄã WKT Â§öÈÇäÂΩ¢Âà∞ traffic-events
      function parseWKTPolygon(wkt: string): [number, number][] | null {
        const match = wkt.match(/POLYGON\s*\(\((.+)\)\)/i);
        if (!match) return null;
        return match[1].split(",").map((pt) => {
          const [lng, lat] = pt.trim().split(/\s+/).map(Number);
          return [lng, lat];
        });
      }

      const testWKT =
        "POLYGON((121.29448166146477 24.919028160170058,121.29447693632446 24.919024108525516,121.29447118359082 24.919028420114472,121.29447512662043 24.919034145364016,121.29448166146477 24.919028160170058))";
      const points = parseWKTPolygon(testWKT);
      if (points) {
        const polygon = new Polygon({
          rings: [points],
          spatialReference: { wkid: 4326 },
        });
        const polygonGraphic = new Graphic({
          geometry: polygon,
          symbol: {
            type: "simple-fill",
            color: [255, 0, 0, 0.3],
            outline: { color: [255, 0, 0], width: 2 },
          },
          attributes: { test: true },
        });
        const trafficLayer = view.current.map.findLayerById("traffic-events");
        if (trafficLayer && "add" in trafficLayer) {
          // @ts-ignore
          trafficLayer.add(polygonGraphic);
          const location = getPolygonCentroid(points);
          view.current.goTo({
            center: location,
            zoom: 15,
          });
        }
      }

      console.log("Âú∞ÂúñÂàùÂßãÂåñÂÆåÊàê");
    } catch (error) {
      console.error("Âú∞ÂúñÂàùÂßãÂåñÂ§±Êïó:", error);
    }
  };

  const updateMapLayers = async () => {
    try {
      const trafficLayer = view.current?.map?.findLayerById("traffic-events");
      const parkingLayer = view.current?.map?.findLayerById("parking-lots");
      if (trafficLayer) trafficLayer.removeAll();
      if (parkingLayer) parkingLayer.removeAll();

      // Ê∑ªÂä†‰∫§ÈÄö‰∫ã‰ª∂
      if (selectedLayers.traffic && trafficEvents.length > 0) {
        const trafficGraphics = trafficEvents
          .filter((event) => event.location)
          .map((event) => {
            const point = new Point({
              longitude: event.location.lng,
              latitude: event.location.lat,
            });

            const symbol = new SimpleMarkerSymbol({
              style: "circle",
              color: getEventColor(event.type),
              size: "12px",
              outline: { color: "white", width: 2 },
            });

            return new Graphic({
              geometry: point,
              symbol: symbol,
              attributes: event,
              popupTemplate: {
                title: "üö® {title}",
                content: `
                  <div style="padding: 10px;">
                    <p><strong>‰∫ã‰ª∂È°ûÂûã:</strong> {type}</p>
                    <p><strong>ÊèèËø∞:</strong> {description}</p>
                    <p><strong>ÈñãÂßãÊôÇÈñì:</strong> {startTime}</p>
                  </div>
                `,
              },
            });
          });

        trafficLayer?.addMany(trafficGraphics);
      }

      // Ê∑ªÂä†ÂÅúËªäÂ†¥
      if (selectedLayers.parking && parkingLots.length > 0) {
        const parkingGraphics = parkingLots
          .filter((lot) => lot.location && lot.location.lat && lot.location.lng)
          .map((lot) => {
            const point = new Point({
              longitude: lot.location.lng,
              latitude: lot.location.lat,
            });

            const symbol = new SimpleMarkerSymbol({
              style: "square",
              color: [33, 150, 243, 0.8],
              size: "16px",
              outline: { color: "white", width: 2 },
            });

            return new Graphic({
              geometry: point,
              symbol: symbol,
              attributes: lot,
              popupTemplate: {
                title: "üÖøÔ∏è {name}",
                content: `
                  <div style="padding: 10px;">
                    <p><strong>Á∏ΩËªä‰Ωç:</strong> {totalSpaces}</p>
                    <p><strong>Ââ©È§òËªä‰Ωç:</strong> {availableSpaces}</p>
                  </div>
                `,
              },
            });
          });

        parkingLayer.addMany(parkingGraphics);
      }
    } catch (error) {
      console.error("Êõ¥Êñ∞Âú∞ÂúñÂúñÂ±§Â§±Êïó:", error);
    }
  };

  const getEventColor = (eventType) => {
    const colors = {
      1: [244, 67, 54], // ‰∫§ÈÄö‰∫ãÊïÖ - Á¥ÖËâ≤
      2: [255, 152, 0], // ÊñΩÂ∑• - Ê©òËâ≤
      3: [255, 193, 7], // Â£ÖÂ°û - ÈªÉËâ≤
      4: [156, 39, 176], // ÁâπÊÆäÁÆ°Âà∂ - Á¥´Ëâ≤
      5: [96, 125, 139], // Â§©Ê∞£ - ÁÅ∞Ëâ≤
      6: [139, 69, 19], // ÁÅΩÂÆ≥ - ÂíñÂï°Ëâ≤
      7: [63, 81, 181], // Ê¥ªÂãï - ËóçËâ≤
      8: [76, 175, 80], // ÂÖ∂‰ªñÁï∞Â∏∏ - Á∂†Ëâ≤
    };
    return colors[eventType] || [158, 158, 158];
  };

  return (
    <Box
      ref={mapDiv}
      sx={{
        height: "100%",
        width: "100%",
        "& .esri-ui-corner": {
          zIndex: 1000,
        },
      }}
    />
  );
};

// services/tdxService.js (Á∞°ÂåñÁâàÊú¨)
class TDXService {
  constructor() {
    this.baseURL = "https://tdx.transportdata.tw/api";
  }

  async getTrafficEvents(city = "Taichung") {
    try {
      // Ê®°Êì¨ API ÂõûÊáâ
      return [
        {
          id: "1",
          title: "ÊñáÂøÉË∑ØËªäÁ¶ç",
          description: "ÊñáÂøÉË∑ØËàáÂè∞ÁÅ£Â§ßÈÅìË∑ØÂè£ÁôºÁîüËªäÁ¶ç",
          type: 1,
          location: { lng: 120.6478, lat: 24.1477 },
          startTime: new Date().toISOString(),
        },
        {
          id: "2",
          title: "‰∫îÊ¨äË∑ØÊñΩÂ∑•",
          description: "‰∫îÊ¨äË∑ØÈÄ≤Ë°åÈÅìË∑ØÁ∂≠‰øÆ",
          type: 2,
          location: { lng: 120.6521, lat: 24.1398 },
          startTime: new Date().toISOString(),
        },
      ];
    } catch (error) {
      console.error("ÂèñÂæó‰∫§ÈÄö‰∫ã‰ª∂Â§±Êïó:", error);
      return [];
    }
  }

  async getParkingData(city = "Taichung") {
    try {
      // Ê®°Êì¨ÂÅúËªäÂ†¥Ë≥áÊñô
      return [
        {
          id: "P1",
          name: "Âè∞‰∏≠ÁÅ´ËªäÁ´ôÂÅúËªäÂ†¥",
          location: { lng: 120.6478, lat: 24.1477 },
          totalSpaces: 100,
          availableSpaces: 45,
        },
        {
          id: "P2",
          name: "‰∏≠ÂçÄÂÅúËªäÂ†¥",
          location: { lng: 120.6542, lat: 24.1469 },
          totalSpaces: 80,
          availableSpaces: 23,
        },
      ];
    } catch (error) {
      console.error("ÂèñÂæóÂÅúËªäÂ†¥Ë≥áÊñôÂ§±Êïó:", error);
      return [];
    }
  }
}
export const tdxService = new TDXService();
